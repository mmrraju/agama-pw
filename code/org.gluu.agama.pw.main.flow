Flow org.gluu.agama.pw.main
     Basepath ""
     Timeout 500 seconds
     Configs conf
Log "@info Start execution of the password validation flow."
//  Create json variable for UI feedback.
uiFeedback = {}
// Get an instance of PasswordService Class.
validationService = Call org.gluu.agama.pw.PasswordService#getInstance conf
// Iterate x times max
Repeat 6 times max
     // Retrieve user credentials from UI.
     credentials = RRF "login-basic.ftlh" uiFeedback
     // If forget password
     When credentials.forgetpassword is true
          // Forget password start
          Log "@info Forget password portion starting"
          // Max 3 times repeat
          Repeat 3 times max
               // Assign mail form feedback 
               mailUIFeedback = {}
               // Mail form
               mailForm = RRF "mailform.ftlh" mailUIFeedback
               // Check user exist or not with this mail.
               user = Call validationService getUserEntityByMail mailForm.mail
               // If user found.
               When user.empty is not true
                    // User found with e-mail 
                    Log "@info User found with e-mail % " mailForm.mail
                    // OTP to verify user
                    otp = Call validationService sendEmail mailForm.mail
                    // OTP form feedback
                    otpFormFeedback = {}
                    // Max 3 times repeat 
                    Repeat 3 times max
                         // OTP Form 
                         otpFormData = RRF "otp.ftlh" otpFormFeedback
                         // If OTP match
                         When otpFormData.passcode is otp
                              // OTP matches
                              Log "@info OTP matches"
                              // Assign variable Re-set Password Form Feedback 
                              resetPassFormFeedback = {}
                              // Max 3 times repeat
                              Repeat 3 times max
                                   // Re-set Password Form
                                   passFormData = RRF "passwordForm.ftlh" resetPassFormFeedback
                                   // Check password policy
                                   isPassPolicyMatch = Call validationService passwordPolicyMatch passFormData.userPassword
               Otherwise
                    // User not found
                    mailUIFeedback.errorMessage = "User not found"
     Otherwise
          // Validate provided user credentials
          uiFeedback.succeed = Call validationService validate credentials.username credentials.password
          // If user credentials is valid, the flow end successfully.
          When uiFeedback.succeed is true
               // add entry in log file for successfull login attempt.
               Log "@info Valid credentials provided"
               // Password validation completed successfuly!
               Finish credentials.username
          // Invalid credentials provided.
          Log "@error Invalid credentials provided"
          When conf.enableLock is true
               // Lock user account if needed or unlock if the expiration time  is over.
               lockResult = Call validationService lockAccount credentials.username
               Log "@info Account lock result" lockResult
               uiFeedback.lockMessage = lockResult
          // Maximum attempts reached. Password validation failed!
          Log "@info Maximum attempts reached. Password validation failed."
          uiFeedback.errorMessage = "Invalid credentials. Please try again!"
          uiFeedback.uid = credentials.username
// The login flow will end here with failure.
Log "@info The maximum login attempt has been reached!"
// Maximum attempts reached. Password validation failed!
it_qatke = {success:false, error: "Password validation failed!"}
Finish it_qatke